name: 'Pull Requestå®¡æ ¸æ£€æŸ¥'
on:
  pull_request_review:
    types: [submitted, edited, dismissed]
  pull_request:
    types: [opened, reopened, labeled, unlabeled, synchronize, review_requested, review_request_removed]
    branches:
      - master

jobs:
  check-reviews:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€æŸ¥PRæ˜¯å¦æœ‰ç®¡ç†å‘˜å®¡æ ¸
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // è·å–PRä¿¡æ¯
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // å¦‚æœPRä¸æ˜¯é’ˆå¯¹ˆ†æ”¯ï¼Œåˆ™è·³è¿‡æ£€æŸ¥
            if (pr.base.ref !== 'main') {
              console.log('è¿™ä¸æ˜¯é’ˆå¯¹ˆ†æ”¯çš„PRï¼Œè·³è¿‡æ£€æŸ¥');
              return;
            }
            
            // è·å–æ‰€æœ‰å®¡æ ¸
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // ç®¡ç†å‘˜ç”¨æˆ·å
            const adminUser = 'hypier';
            
            // è·å–æ¯ä¸ªç”¨æˆ·çš„æœ€æ–°å®¡æ ¸çŠ¶æ€
            const reviewsByUser = {};
            reviews.forEach(review => {
              reviewsByUser[review.user.login] = review;
            });
            
            // æ£€æŸ¥ç®¡ç†å‘˜æ˜¯å¦æ‰¹å‡†
            const adminApproved = reviewsByUser[adminUser] && reviewsByUser[adminUser].state === 'APPROVED';
            
            // è®¾ç½®æ£€æŸ¥ç»“æœ
            if (!adminApproved) {
              core.setFailed('æ­¤PRéœ€è¦hypierç®¡ç†å‘˜å®¡æ ¸å¹¶æ‰¹å‡†æ‰èƒ½åˆå¹¶åˆ°ˆ†æ”¯');
            } else {
              console.log('PRå·²è·å¾—hypierç®¡ç†å‘˜æ‰¹å‡†ï¼Œå¯ä»¥åˆå¹¶');
            }
      
      - name: æ›´æ–°PRçŠ¶æ€å’Œæ·»åŠ é€šçŸ¥
        if: always()
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // è·å–PRä¿¡æ¯
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // è·å–æ‰€æœ‰å®¡æ ¸
            const { data: reviews } = await github.rest.pulls.listReviews({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            // ç®¡ç†å‘˜ç”¨æˆ·å
            const adminUser = 'hypier';
            
            // è·å–æ¯ä¸ªç”¨æˆ·çš„æœ€æ–°å®¡æ ¸çŠ¶æ€
            const reviewsByUser = {};
            reviews.forEach(review => {
              reviewsByUser[review.user.login] = review;
            });
            
            // æ£€æŸ¥ç®¡ç†å‘˜æ˜¯å¦æ‰¹å‡†
            const adminApproved = reviewsByUser[adminUser] && reviewsByUser[adminUser].state === 'APPROVED';
            
            // åˆ›å»ºçŠ¶æ€æ£€æŸ¥
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: pr.head.sha,
              state: adminApproved ? 'success' : 'pending',
              description: adminApproved ? `å·²è·å¾—hypierç®¡ç†å‘˜æ‰¹å‡†` : 'éœ€è¦hypierç®¡ç†å‘˜å®¡æ ¸æ‰¹å‡†',
              context: 'ç®¡ç†å‘˜å®¡æ ¸æ£€æŸ¥'
            });
            
            // æ·»åŠ æ ‡ç­¾
            const needReviewLabel = 'éœ€è¦å®¡æ ¸';
            const approvedLabel = 'å·²å®¡æ ¸';
            
            const { data: labels } = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });
            
            const hasNeedReviewLabel = labels.some(label => label.name === needReviewLabel);
            const hasApprovedLabel = labels.some(label => label.name === approvedLabel);
            
            try {
              if (!adminApproved && !hasNeedReviewLabel) {
                // æ·»åŠ éœ€è¦å®¡æ ¸æ ‡ç­¾
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [needReviewLabel]
                });
                
                // å¦‚æœæœ‰å·²å®¡æ ¸æ ‡ç­¾ï¼Œç§»é™¤å®ƒ
                if (hasApprovedLabel) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: approvedLabel
                  });
                }
              } else if (adminApproved && !hasApprovedLabel) {
                // æ·»åŠ å·²å®¡æ ¸æ ‡ç­¾
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  labels: [approvedLabel]
                });
                
                // å¦‚æœæœ‰éœ€è¦å®¡æ ¸æ ‡ç­¾ï¼Œç§»é™¤å®ƒ
                if (hasNeedReviewLabel) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: context.issue.number,
                    name: needReviewLabel
                  });
                }
              }
            } catch (error) {
              console.log('æ ‡ç­¾æ“ä½œé”™è¯¯ï¼Œå¯èƒ½æ˜¯æ ‡ç­¾ä¸å­˜åœ¨: ' + error.message);
            }
            
            // å¦‚æœæ˜¯æ–°PRæˆ–æ–°çš„å®¡æ ¸ï¼Œæ·»åŠ è¯„è®º
            if (github.context.payload.action === 'opened' || 
                github.context.payload.action === 'submitted') {
              const commentBody = adminApproved 
                ? `âœ… æ­¤PRå·²è·å¾—ç®¡ç†å‘˜ @hypier çš„æ‰¹å‡†ï¼Œå¯ä»¥åˆå¹¶åˆ°ˆ†æ”¯ã€‚`
                : `âš ï¸ æ­¤PRéœ€è¦ç®¡ç†å‘˜ @hypier å®¡æ ¸æ‰¹å‡†æ‰èƒ½åˆå¹¶åˆ°ˆ†æ”¯ã€‚`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }